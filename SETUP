#!/bin/bash

USER_FOLDER=/home/$1

if [ ! -e $USER_FOLDER/.config/device ]; then
  if [ $2 ]; then
		if [ ! -e ./devices/$2 ]; then
			echo "$2 is not a valid device"
		else
			DEVICE=$2
			echo $DEVICE > $USER_FOLDER/.config/device
			FIRST=first
		fi
	else
		echo "No device defined"
	fi
else
	DEVICE=$(cat $USER_FOLDER/.config/device)
fi

sudo notify-send "Updating apt packages, may take a while..." && sudo apt update && sudo apt upgrade -y && notify-send "Success!" "Updated apt packages"

if [ "$FIRST" == "first" ]; then
	mkdir -p $USER_FOLDER/Pictures/Wallpapers $USER_FOLDER/Pictures/Screenshots $USER_FOLDER/Projects

	# Install base apps
	sudo apt install -y curl xinit xserver-xorg i3 feh dconf uuid-runtime

	# Install vscode prerequisites
	curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
	sudo mv microsoft.gpg /etc/apt/trusted.gpg.d/microsoft.gpg
	sudo sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/vscode stable main" > /etc/apt/sources.list.d/vscode.list'

	# Purge unused apps
	sudo apt purge -y totem

	# Install nvm
	curl -o- https://raw.githubusercontent.com/creationix/nvm/v0.33.11/install.sh | bash

	export NVM_DIR="$HOME/.nvm"
	[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" # This loads nvm

	nvm install --lts

	sudo ln -s "$NVM_DIR/versions/node/$(nvm version)/bin/node" "/usr/local/bin/node"
	sudo ln -s "$NVM_DIR/versions/node/$(nvm version)/bin/npm" "/usr/local/bin/npm"

	# Install global npm packages
	npm i -g eslint gulp

	sudo gpasswd -a $1 input

	git config --global credential.helper cache
	git config --global credential.helper 'cache --timeout=3600'

	(cd ./gnome-terminal && ./SETUP)
	(cd ./fonts && ./SETUP)

	cp ./etc/gtk_dark_preference $USER_FOLDER/.config/gtk-3.0/settings.ini

	# install sudo config
	sudo cp ./etc/sudo.conf /etc/

	sudo adduser $1 dialout
fi

cat ./etc/.bashrc >> $USER_FOLDER/.bashrc

# Install apps
sudo apt install -y libinput-tools xdotool wmctrl build-essential make cpanminus autoconf automake xautolock pavucontrol leafpad xbacklight speedtest-cli xclip code default-jre gimp gpick openssh-server ffmpeg arp-scan scrot youtube-dl ruby vlc mpv dnsmasq mongodb cu net-tools libcanberra-gtk-module libcanberra-gtk3-module

(cd ./devices/$DEVICE && cp ./.profile $USER_FOLDER/)
(cd ./devices/$DEVICE && cp ./.wallpaper_subreddits $USER_FOLDER/Pictures/Wallpapers/.subreddits)

(cd ./scripts && ./SETUP $1)
(cd ./dunst && ./SETUP $1)
(cd ./i3 && ./SETUP $1)

(cd ./devices/$DEVICE && ./SETUP $1 $FIRST)