#!/bin/bash

dotfiles_folder=$HOME/Projects/dotfiles

if [ ! -e $HOME/.config/device ]; then
	if [ $1 ]; then
		if [ ! -e $dotfiles_folder/devices/$1 ]; then
			echo "$1 is not a valid device"
		else
			DEVICE=$1
			FIRST=first

			echo $DEVICE > $HOME/.config/device
		fi
	else
		echo "No device defined"
	fi
else
	DEVICE=$(cat $HOME/.config/device)
fi

notify-send "Updating apt packages, may take a while..."

sudo apt update && sudo apt upgrade -y && notify-send "Success!" "Updated apt packages"

if [ "$FIRST" == "first" ]; then
	mkdir -p $HOME/Pictures/Wallpapers $HOME/Pictures/Screenshots $HOME/Projects

	# Install base apps
	sudo apt install -y curl xinit xserver-xorg i3 feh dconf-tools uuid-runtime gnome-terminal libnotify-bin dnsmasq fonts-font-awesome pasystray

	# Purge unused apps
	sudo apt purge -y totem

	sudo gpasswd -a $USER input

	git config --global credential.helper cache
	git config --global credential.helper 'cache --timeout=3600'

	$dotfiles_folder/gnome-terminal/SETUP
	$dotfiles_folder/fonts/SETUP
	$dotfiles_folder/nvm/SETUP

	# Install dark theme preference
	cp $dotfiles_folder/etc/gtk_dark_preference $HOME/.config/gtk-3.0/settings.ini

	# Install sudo config
	sudo cp $dotfiles_folder/etc/sudo.conf /etc/

	sudo adduser $USER dialout

	sudo setcap 'cap_net_bind_service=+ep' `which node`

	ulimit -Sn unlimited
	ulimit -Sl unlimited

	cat $dotfiles_folder/etc/.bashrc >> $HOME/.bashrc

	mkdir -p $HOME/.bashrc.d
fi

# Install apps
sudo apt install -y libinput-tools xdotool wmctrl build-essential make cpanminus autoconf automake xautolock pavucontrol leafpad xbacklight speedtest-cli xclip default-jre openssh-server ffmpeg arp-scan scrot youtube-dl ruby cu net-tools libcanberra-gtk-module libcanberra-gtk3-module

cp $dotfiles_folder/devices/$DEVICE/.profile $HOME/

cp $dotfiles_folder/devices/$DEVICE/.wallpaper_subreddits $HOME/Pictures/Wallpapers/.subreddits

cp $dotfiles_folder/etc/.bash_profile $HOME/

rm -f $HOME/.bashrc.d/*

cp $dotfiles_folder/bashrc/* $HOME/.bashrc.d/

$dotfiles_folder/scripts/SETUP
$dotfiles_folder/dunst/SETUP
$dotfiles_folder/i3/SETUP

$dotfiles_folder/devices/$DEVICE/SETUP $FIRST

if [ "$FIRST" == "first" ]; then
	$dotfiles_folder/dnsmasq/SETUP

	echo -e "\nReady to reboot. [enter] to continue."

	read -p ""

	sudo shutdown -r now
fi

notify-send "Done updating system!"
