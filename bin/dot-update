#!/bin/zsh

source "$(dirname ${BASH_SOURCE[0]:-${(%):-%x}})/lib/dot-util" "$0" "$@"

obtainSudo

(cd $dotfilesPath ; git pull)

if [ ! -e $HOME/.dotfiles ]; then
	ln -sf $dotfilesPath $HOME/.dotfiles
fi

if [ "$profileName" ]; then
	echo "Profile: $profileName"
elif [ "$1" ] && [ -d "$dotfilesPath/profiles/$1" ]; then
	profileName=$1
else
	echo -e "\n\"$1\" is not a valid profile. You can provide one as an argument, eg: $0 <profile>\n\n$(ls $dotfilesPath/profiles)\n"

	read profileName

	exit #?
fi

echo $profileName > $HOME/.dotfilesProfile
profilePath="$dotfilesPath/profiles/$profileName"

# echo "Adding $USER to groups: $groupsToAdd"

# groupsToAdd=(input dialout)

# for group in $groupsToAdd; do
# 	sudo adduser $USER $group
# done

echo "Creating common directories"
mkdir -p $HOME/Pictures/Wallpapers $HOME/Pictures/Screenshots $HOME/Projects

echo "Linking zsh config"
mkdir -p $HOME/.zshrc.d $HOME/.zshenv.d

ln -sf $profilePath/.zshenv $HOME/.zshenv
ln -sf $profilePath/.zshrc $HOME/.zshrc

echo "Linking kitty config"
mkdir -p $HOME/.config/kitty
ln -sf $dotfilesPath/kitty.conf $HOME/.config/kitty/kitty.conf

echo "Linking vscode argv config"
mkdir -p $HOME/.vscode
ln -sf $dotfilesPath/vscode/argv.json $HOME/.vscode/argv.json

if [[ ! -a $(which brew) ]]; then
	echo "Installing brew"

  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
fi

brew update

brew tap homebrew/bundle

(cd $dotfilesPath ; brew bundle --no-lock)

if [[ ! -a $HOME/.nvm ]]; then
	echo "Installing NVM"

	curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.38.0/install.sh | bash
fi

source "$dotfilesPath/zshrc/nvm"

$binPath/nvm-use ${GLOBAL_NODE_VERSION:-12}

echo "Installing global npm packages"

globalNpmPackages=(pm2 npm-check-updates fatlard1993/zelda)

for package in $globalNpmPackages; do
	npm list -g | grep $package || npm i -g $package
done

pm2 update

echo "Configuring profile"
$profilePath/dot-update

echo "Configuring priv-config"
$dotfilesPath/../priv-config/update

if [[ ! -a $HOME/Projects/home-page ]]; then
	echo "Installing home-page"

	(
		cd $HOME/Projects

		git clone https://github.com/fatlard1993/home-page

		cd $HOME/Projects/home-page

		npm i

		pm2 start --name home-page ./src/server/index.js

		pm2 save
	)
else
	echo "Updating home-page"

	(
		pm2 stop home-page

		cd $HOME/Projects/home-page

		git pull

		rm -rf ./node_modules

		npm i

		pm2 start home-page

		pm2 save
	)
fi